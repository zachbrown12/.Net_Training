/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Injectable } from '@angular/core';
import { TimeagoIntl } from './timeago.intl';
import { MINUTE, HOUR, DAY, WEEK, MONTH, YEAR } from './util';
const /** @type {?} */ defaultFormattter = function (then) {
    const /** @type {?} */ now = Date.now();
    const /** @type {?} */ seconds = Math.round(Math.abs(now - then) / 1000);
    const /** @type {?} */ suffix = then < now ? 'ago' : 'from now';
    const [value, unit] = seconds < MINUTE
        ? [Math.round(seconds), 'second']
        : seconds < HOUR
            ? [Math.round(seconds / MINUTE), 'minute']
            : seconds < DAY
                ? [Math.round(seconds / HOUR), 'hour']
                : seconds < WEEK
                    ? [Math.round(seconds / DAY), 'day']
                    : seconds < MONTH
                        ? [Math.round(seconds / WEEK), 'week']
                        : seconds < YEAR
                            ? [Math.round(seconds / MONTH), 'month']
                            : [Math.round(seconds / YEAR), 'year'];
    return { value, unit, suffix };
};
const ɵ0 = defaultFormattter;
/**
 * @abstract
 */
export class TimeagoFormatter {
}
function TimeagoFormatter_tsickle_Closure_declarations() {
    /**
     * @abstract
     * @param {?} then
     * @return {?}
     */
    TimeagoFormatter.prototype.format = function (then) { };
}
export class TimeagoDefaultFormatter extends TimeagoFormatter {
    /**
     * @param {?} then
     * @return {?}
     */
    format(then) {
        const { suffix, value, unit } = defaultFormattter(then);
        return this.parse(value, unit, suffix);
    }
    /**
     * @param {?} value
     * @param {?} unit
     * @param {?} suffix
     * @return {?}
     */
    parse(value, unit, suffix) {
        if (value !== 1) {
            unit += 's';
        }
        return value + ' ' + unit + ' ' + suffix;
    }
}
TimeagoDefaultFormatter.decorators = [
    { type: Injectable },
];
export class TimeagoCustomFormatter extends TimeagoFormatter {
    /**
     * @param {?} intl
     */
    constructor(intl) {
        super();
        this.intl = intl;
    }
    /**
     * @param {?} then
     * @return {?}
     */
    format(then) {
        const { suffix, value, unit } = defaultFormattter(then);
        return this.parse(value, unit, suffix, Date.now(), then);
    }
    /**
     * @param {?} value
     * @param {?} unit
     * @param {?} suffix
     * @param {?} now
     * @param {?} then
     * @return {?}
     */
    parse(value, unit, suffix, now, then) {
        /** convert weeks to days if strings don't handle weeks */
        if (unit === 'week' && !this.intl.strings.week && !this.intl.strings.weeks) {
            const /** @type {?} */ days = Math.round(Math.abs(now - then) / (1000 * 60 * 60 * 24));
            value = days;
            unit = 'day';
        }
        /**
         * create a normalize function for given value
         */
        const /** @type {?} */ normalize = this.normalizeFn(value, now - then, this.intl.strings.numbers);
        /**
         * The eventual return value stored in an array so that the wordSeparator can be used
         */
        const /** @type {?} */ dateString = [];
        /** handle prefixes */
        if (suffix === 'ago' && this.intl.strings.prefixAgo) {
            dateString.push(normalize(this.intl.strings.prefixAgo));
        }
        if (suffix === 'from now' && this.intl.strings.prefixFromNow) {
            dateString.push(normalize(this.intl.strings.prefixFromNow));
        }
        /**
         * Handle Main number and unit
         */
        const /** @type {?} */ isPlural = value > 1;
        if (isPlural) {
            const /** @type {?} */ stringFn = this.intl.strings[unit + 's'] || this.intl.strings[unit] || '%d ' + unit;
            dateString.push(normalize(stringFn));
        }
        else {
            const /** @type {?} */ stringFn = this.intl.strings[unit] || this.intl.strings[unit + 's'] || '%d ' + unit;
            dateString.push(normalize(stringFn));
        }
        /** Handle Suffixes */
        if (suffix === 'ago' && this.intl.strings.suffixAgo) {
            dateString.push(normalize(this.intl.strings.suffixAgo));
        }
        if (suffix === 'from now' && this.intl.strings.suffixFromNow) {
            dateString.push(normalize(this.intl.strings.suffixFromNow));
        }
        /**
         * join the array into a string and return it
         */
        const /** @type {?} */ wordSeparator = typeof this.intl.strings.wordSeparator === 'string' ? this.intl.strings.wordSeparator : ' ';
        return dateString.join(wordSeparator);
    }
    /**
     * If the numbers array is present, format numbers with it,
     * otherwise just cast the number to a string and return it
     * @param {?} numbers
     * @param {?} value
     * @return {?}
     */
    normalizeNumber(numbers, value) {
        return numbers && numbers.length === 10
            ? String(value).split('')
                .map((digit) => digit.match(/^[0-9]$/) ? numbers[parseInt(digit, 10)] : digit)
                .join('')
            : String(value);
    }
    /**
     * Take a string or a function that takes number of days and returns a string
     * and provide a uniform API to create string parts
     * @param {?} value
     * @param {?} millisDelta
     * @param {?=} numbers
     * @return {?}
     */
    normalizeFn(value, millisDelta, numbers) {
        return (stringOrFn) => typeof stringOrFn === 'function'
            ? stringOrFn(value, millisDelta).replace(/%d/g, this.normalizeNumber(numbers, value))
            : stringOrFn.replace(/%d/g, this.normalizeNumber(numbers, value));
    }
}
TimeagoCustomFormatter.decorators = [
    { type: Injectable },
];
/** @nocollapse */
TimeagoCustomFormatter.ctorParameters = () => [
    { type: TimeagoIntl }
];
function TimeagoCustomFormatter_tsickle_Closure_declarations() {
    /** @type {?} */
    TimeagoCustomFormatter.prototype.intl;
}
export { ɵ0 };

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZWFnby5mb3JtYXR0ZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtdGltZWFnby8iLCJzb3VyY2VzIjpbInRpbWVhZ28uZm9ybWF0dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3QyxPQUFPLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFVOUQsdUJBQU0saUJBQWlCLEdBQUcsVUFBUyxJQUFZO0lBQzdDLHVCQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDdkIsdUJBQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7SUFDeEQsdUJBQU0sTUFBTSxHQUFXLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDO0lBRXZELE1BQU0sQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEdBQ2pCLE9BQU8sR0FBRyxNQUFNO1FBQ2QsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxRQUFRLENBQUM7UUFDakMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxJQUFJO1lBQ2QsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLEVBQUUsUUFBUSxDQUFDO1lBQzFDLENBQUMsQ0FBQyxPQUFPLEdBQUcsR0FBRztnQkFDYixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsRUFB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LE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQzs7Ozs7Ozs7OztJQU9aLFdBQVcsQ0FBQyxLQUFhLEVBQUUsV0FBbUIsRUFBRSxPQUFxQjtRQUMzRSxNQUFNLENBQUMsQ0FBQyxVQUFzQixFQUFFLEVBQUUsQ0FDaEMsT0FBTyxVQUFVLEtBQUssVUFBVTtZQUNoQyxDQUFDLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3JGLENBQUMsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDOzs7O1lBNUV2RSxVQUFVOzs7O1lBckRGLFdBQVciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBUaW1lYWdvSW50bCB9IGZyb20gJy4vdGltZWFnby5pbnRsJztcbmltcG9ydCB7IE1JTlVURSwgSE9VUiwgREFZLCBXRUVLLCBNT05USCwgWUVBUiB9IGZyb20gJy4vdXRpbCc7XG5cbmV4cG9ydCB0eXBlIFVuaXQgPSAnc2Vjb25kJyB8ICdtaW51dGUnIHwgJ2hvdXInIHwgJ2RheScgfCAnd2VlaycgfCAnbW9udGgnIHwgJ3llYXInO1xuXG5leHBvcnQgdHlwZSBTdWZmaXggPSAnYWdvJyB8ICdmcm9tIG5vdyc7XG5cbmV4cG9ydCB0eXBlIFN0cmluZ09yRm4gPSAoKHZhbHVlOiBudW1iZXIsIG1pbGxpc0RlbHRhOiAgbnVtYmVyKSA9PiBzdHJpbmcpIHwgc3RyaW5nO1xuXG5leHBvcnQgdHlwZSBOdW1iZXJBcnJheSA9IFsgc3RyaW5nLCBzdHJpbmcsIHN0cmluZywgc3RyaW5nLCBzdHJpbmcsIHN0cmluZywgc3RyaW5nLCBzdHJpbmcsIHN0cmluZywgc3RyaW5nIF07XG5cbmNvbnN0IGRlZmF1bHRGb3JtYXR0dGVyID0gZnVuY3Rpb24odGhlbjogbnVtYmVyKToge3ZhbHVlOiBudW1iZXIsIHVuaXQ6IFVuaXQsIHN1ZmZpeDogU3VmZml4fSB7XG4gIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gIGNvbnN0IHNlY29uZHMgPSBNYXRoLnJvdW5kKE1hdGguYWJzKG5vdyAtIHRoZW4pIC8gMTAwMCk7XG4gIGNvbnN0IHN1ZmZpeDogU3VmZml4ID0gdGhlbiA8IG5vdyA/ICdhZ28nIDogJ2Zyb20gbm93JztcblxuICBjb25zdCBbdmFsdWUsIHVuaXRdOiBbbnVtYmVyLCBVbml0XSA9XG4gICAgc2Vjb25kcyA8IE1JTlVURVxuICAgICAgPyBbTWF0aC5yb3VuZChzZWNvbmRzKSwgJ3NlY29uZCddXG4gICAgICA6IHNlY29uZHMgPCBIT1VSXG4gICAgICAgID8gW01hdGgucm91bmQoc2Vjb25kcyAvIE1JTlVURSksICdtaW51dGUnXVxuICAgICAgICA6IHNlY29uZHMgPCBEQVlcbiAgICAgICAgICA/IFtNYXRoLnJvdW5kKHNlY29uZHMgLyBIT1VSKSwgJ2hvdXInXVxuICAgICAgICAgIDogc2Vjb25kcyA8IFdFRUtcbiAgICAgICAgICAgID8gW01hdGgucm91bmQoc2Vjb25kcyAvIERBWSksICdkYXknXVxuICAgICAgICAgICAgOiBzZWNvbmRzIDwgTU9OVEhcbiAgICAgICAgICAgICAgPyBbTWF0aC5yb3VuZChzZWNvbmRzIC8gV0VFSyksICd3ZWVrJ11cbiAgICAgICAgICAgICAgOiBzZWNvbmRzIDwgWUVBUlxuICAgICAgICAgICAgICAgID8gW01hdGgucm91bmQoc2Vjb25kcyAvIE1PTlRIKSwgJ21vbnRoJ11cbiAgICAgICAgICAgICAgICA6IFtNYXRoLnJvdW5kKHNlY29uZHMgLyBZRUFSKSwgJ3llYXInXTtcblxuICByZXR1cm4ge3ZhbHVlLCB1bml0LCBzdWZmaXh9O1xufVxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgVGltZWFnb0Zvcm1hdHRlciB7XG4gIGFic3RyYWN0IGZvcm1hdCh0aGVuOiBudW1iZXIpOiBzdHJpbmdcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFRpbWVhZ29EZWZhdWx0Rm9ybWF0dGVyIGV4dGVuZHMgVGltZWFnb0Zvcm1hdHRlciB7XG4gIGZvcm1hdCh0aGVuOiBudW1iZXIpOiBzdHJpbmcge1xuICAgIGNvbnN0IHtzdWZmaXgsIHZhbHVlLCB1bml0fSA9IGRlZmF1bHRGb3JtYXR0dGVyKHRoZW4pO1xuICAgIHJldHVybiB0aGlzLnBhcnNlKHZhbHVlLCB1bml0LCBzdWZmaXgpO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZSh2YWx1ZTogbnVtYmVyLCB1bml0OiBVbml0LCBzdWZmaXg6IFN1ZmZpeCk6IHN0cmluZyB7XG4gICAgaWYgKHZhbHVlICE9PSAxKSB7XG4gICAgICB1bml0ICs9ICdzJztcbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlICsgJyAnICsgdW5pdCArICcgJyArIHN1ZmZpeDtcbiAgfVxufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgVGltZWFnb0N1c3RvbUZvcm1hdHRlciBleHRlbmRzIFRpbWVhZ29Gb3JtYXR0ZXIge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGludGw6IFRpbWVhZ29JbnRsKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIGZvcm1hdCh0aGVuOiBudW1iZXIpOiBzdHJpbmcge1xuICAgIGNvbnN0IHtzdWZmaXgsIHZhbHVlLCB1bml0fSA9IGRlZmF1bHRGb3JtYXR0dGVyKHRoZW4pO1xuICAgIHJldHVybiB0aGlzLnBhcnNlKHZhbHVlLCB1bml0LCBzdWZmaXgsIERhdGUubm93KCksIHRoZW4pO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZSh2YWx1ZTogbnVtYmVyLCB1bml0OiBVbml0LCBzdWZmaXg6IFN1ZmZpeCwgbm93OiBudW1iZXIsIHRoZW46IG51bWJlcikge1xuICAgIC8qKiBjb252ZXJ0IHdlZWtzIHRvIGRheXMgaWYgc3RyaW5ncyBkb24ndCBoYW5kbGUgd2Vla3MgKi9cbiAgICBpZiAodW5pdCA9PT0gJ3dlZWsnICYmICF0aGlzLmludGwuc3RyaW5ncy53ZWVrICYmICF0aGlzLmludGwuc3RyaW5ncy53ZWVrcykge1xuICAgICAgY29uc3QgZGF5cyA9IE1hdGgucm91bmQoTWF0aC5hYnMobm93IC0gdGhlbikgLyAoMTAwMCAqIDYwICogNjAgKiAyNCkpO1xuICAgICAgdmFsdWUgPSBkYXlzO1xuICAgICAgdW5pdCA9ICdkYXknO1xuICAgIH1cblxuICAgIC8qKiBjcmVhdGUgYSBub3JtYWxpemUgZnVuY3Rpb24gZm9yIGdpdmVuIHZhbHVlICovXG4gICAgY29uc3Qgbm9ybWFsaXplID0gdGhpcy5ub3JtYWxpemVGbih2YWx1ZSwgbm93IC0gdGhlbiwgdGhpcy5pbnRsLnN0cmluZ3MubnVtYmVycyk7XG5cbiAgICAvKiogVGhlIGV2ZW50dWFsIHJldHVybiB2YWx1ZSBzdG9yZWQgaW4gYW4gYXJyYXkgc28gdGhhdCB0aGUgd29yZFNlcGFyYXRvciBjYW4gYmUgdXNlZCAqL1xuICAgIGNvbnN0IGRhdGVTdHJpbmc6IHN0cmluZ1tdID0gW107XG5cbiAgICAvKiogaGFuZGxlIHByZWZpeGVzICovXG4gICAgaWYgKHN1ZmZpeCA9PT0gJ2FnbycgJiYgdGhpcy5pbnRsLnN0cmluZ3MucHJlZml4QWdvKSB7XG4gICAgICBkYXRlU3RyaW5nLnB1c2gobm9ybWFsaXplKHRoaXMuaW50bC5zdHJpbmdzLnByZWZpeEFnbykpO1xuICAgIH1cbiAgICBpZiAoc3VmZml4ID09PSAnZnJvbSBub3cnICYmIHRoaXMuaW50bC5zdHJpbmdzLnByZWZpeEZyb21Ob3cpIHtcbiAgICAgIGRhdGVTdHJpbmcucHVzaChub3JtYWxpemUodGhpcy5pbnRsLnN0cmluZ3MucHJlZml4RnJvbU5vdykpO1xuICAgIH1cblxuICAgIC8qKiBIYW5kbGUgTWFpbiBudW1iZXIgYW5kIHVuaXQgKi9cbiAgICBjb25zdCBpc1BsdXJhbCA9IHZhbHVlID4gMTtcbiAgICBpZiAoaXNQbHVyYWwpIHtcbiAgICAgIGNvbnN0IHN0cmluZ0ZuOiBTdHJpbmdPckZuID0gdGhpcy5pbnRsLnN0cmluZ3NbdW5pdCArICdzJ10gfHwgdGhpcy5pbnRsLnN0cmluZ3NbdW5pdF0gfHwgJyVkICcgKyB1bml0O1xuICAgICAgZGF0ZVN0cmluZy5wdXNoKG5vcm1hbGl6ZShzdHJpbmdGbikpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBzdHJpbmdGbjogU3RyaW5nT3JGbiA9IHRoaXMuaW50bC5zdHJpbmdzW3VuaXRdIHx8IHRoaXMuaW50bC5zdHJpbmdzW3VuaXQgKyAncyddIHx8ICclZCAnICsgdW5pdDtcbiAgICAgIGRhdGVTdHJpbmcucHVzaChub3JtYWxpemUoc3RyaW5nRm4pKTtcbiAgICB9XG5cbiAgICAvKiogSGFuZGxlIFN1ZmZpeGVzICovXG4gICAgaWYgKHN1ZmZpeCA9PT0gJ2FnbycgJiYgdGhpcy5pbnRsLnN0cmluZ3Muc3VmZml4QWdvKSB7XG4gICAgICBkYXRlU3RyaW5nLnB1c2gobm9ybWFsaXplKHRoaXMuaW50bC5zdHJpbmdzLnN1ZmZpeEFnbykpO1xuICAgIH1cbiAgICBpZiAoc3VmZml4ID09PSAnZnJvbSBub3cnICYmIHRoaXMuaW50bC5zdHJpbmdzLnN1ZmZpeEZyb21Ob3cpIHtcbiAgICAgIGRhdGVTdHJpbmcucHVzaChub3JtYWxpemUodGhpcy5pbnRsLnN0cmluZ3Muc3VmZml4RnJvbU5vdykpO1xuICAgIH1cblxuICAgIC8qKiBqb2luIHRoZSBhcnJheSBpbnRvIGEgc3RyaW5nIGFuZCByZXR1cm4gaXQgKi9cbiAgICBjb25zdCB3b3JkU2VwYXJhdG9yID0gdHlwZW9mIHRoaXMuaW50bC5zdHJpbmdzLndvcmRTZXBhcmF0b3IgPT09ICdzdHJpbmcnID8gdGhpcy5pbnRsLnN0cmluZ3Mud29yZFNlcGFyYXRvciA6ICcgJztcbiAgICByZXR1cm4gZGF0ZVN0cmluZy5qb2luKHdvcmRTZXBhcmF0b3IpO1xuICB9XG5cbiAgLyoqXG4gICAqIElmIHRoZSBudW1iZXJzIGFycmF5IGlzIHByZXNlbnQsIGZvcm1hdCBudW1iZXJzIHdpdGggaXQsXG4gICAqIG90aGVyd2lzZSBqdXN0IGNhc3QgdGhlIG51bWJlciB0byBhIHN0cmluZyBhbmQgcmV0dXJuIGl0XG4gICovXG4gIHByaXZhdGUgbm9ybWFsaXplTnVtYmVyKG51bWJlcnM6IE51bWJlckFycmF5LCB2YWx1ZTogbnVtYmVyKSB7XG4gICAgcmV0dXJuIG51bWJlcnMgJiYgbnVtYmVycy5sZW5ndGggPT09IDEwXG4gICAgICA/IFN0cmluZyh2YWx1ZSkuc3BsaXQoJycpXG4gICAgICAgICAgLm1hcCgoZGlnaXQ6IHN0cmluZykgPT4gZGlnaXQubWF0Y2goL15bMC05XSQvKSA/IG51bWJlcnNbcGFyc2VJbnQoZGlnaXQsIDEwKV0gOiBkaWdpdClcbiAgICAgICAgICAuam9pbignJylcbiAgICAgIDogU3RyaW5nKHZhbHVlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUYWtlIGEgc3RyaW5nIG9yIGEgZnVuY3Rpb24gdGhhdCB0YWtlcyBudW1iZXIgb2YgZGF5cyBhbmQgcmV0dXJucyBhIHN0cmluZ1xuICAgKiBhbmQgcHJvdmlkZSBhIHVuaWZvcm0gQVBJIHRvIGNyZWF0ZSBzdHJpbmcgcGFydHNcbiAgKi9cbiAgcHJpdmF0ZSBub3JtYWxpemVGbih2YWx1ZTogbnVtYmVyLCBtaWxsaXNEZWx0YTogbnVtYmVyLCBudW1iZXJzPzogTnVtYmVyQXJyYXkpIHtcbiAgICByZXR1cm4gKHN0cmluZ09yRm46IFN0cmluZ09yRm4pID0+XG4gICAgICB0eXBlb2Ygc3RyaW5nT3JGbiA9PT0gJ2Z1bmN0aW9uJ1xuICAgICAgPyBzdHJpbmdPckZuKHZhbHVlLCBtaWxsaXNEZWx0YSkucmVwbGFjZSgvJWQvZywgdGhpcy5ub3JtYWxpemVOdW1iZXIobnVtYmVycywgdmFsdWUpKVxuICAgICAgOiBzdHJpbmdPckZuLnJlcGxhY2UoLyVkL2csIHRoaXMubm9ybWFsaXplTnVtYmVyKG51bWJlcnMsIHZhbHVlKSk7XG4gIH1cbn1cbiJdfQ==